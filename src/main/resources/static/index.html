<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Tatil Takvimi</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        #controls { margin-bottom: 20px; }
        #controls label { margin-right: 5px; font-weight: bold; }
        #calendar { background-color: #fff; padding: 10px; border-radius: 5px; }
        .fc-daygrid-day.fc-day-today { background-color: #ffe4e1; }
        #holidayDetails { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #fff; }
        #holidaySummary { margin-bottom: 20px; }
    </style>
</head>
<body>
<div id="controls">
    <label for="country">Ülke:</label>
    <select id="country"></select>

    <label for="sector">Sektör Tipi:</label>
    <select id="sector"></select>

    <label for="viewSelect">Görünüm:</label>
    <select id="viewSelect">
        <option value="dayGridMonth">Aylık</option>
        <option value="multiMonthYear">Yıllık</option>
    </select>

    <label for="startDate">Başlangıç:</label>
    <input type="date" id="startDate">
    <label for="endDate">Bitiş:</label>
    <input type="date" id="endDate">
    <button id="rangeBtn">Aralığı Hesapla</button>
</div>

<div id="holidaySummary"></div>
<div id="calendar"></div>
<div id="rangeResult"></div>
<div id="holidayDetails"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
// Takvim nesnesini daha geniş bir kapsamda tanımlayalım ki her yerden ulaşılabilsin.
let calendar;

async function loadCountries() {
    try {
        const res = await fetch('/api/countries');
        if (!res.ok) throw new Error('Ülkeler yüklenemedi.');
        const countries = await res.json();
        const select = document.getElementById('country');
        select.innerHTML = ''; // Önceki seçenekleri temizle
        countries.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.countryId;
            opt.textContent = c.countryName;
            select.appendChild(opt);
        });
    } catch (e) {
        console.error(e);
    }
}

async function loadSectorTypes() {
    try {
        const res = await fetch('/api/sector-types');
        if (!res.ok) throw new Error('Sektör tipleri yüklenemedi.');
        const types = await res.json();
        const select = document.getElementById('sector');
        select.innerHTML = ''; // Önceki seçenekleri temizle
        types.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            select.appendChild(opt);
        });
    } catch (e) {
        console.error(e);
    }
}

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 650,
        views: {
            multiMonthYear: { type: 'multiMonth', duration: { months: 12 } }
        },
        events: fetchEvents,
        eventClick: showDetails,
        locale: 'tr'
    });
    calendar.render();
}

function setupEventListeners() {
    // Ülke veya Sektör filtresi değiştiğinde takvimi yenile
    ['country', 'sector'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            // Tarayıcı konsolunda bu mesajı görüyorsanız, filtre çalışıyor demektir.
            console.log(`${id} filtresi değişti. Takvim yenileniyor...`);
            if (calendar) {
                calendar.refetchEvents();
            }
        });
    });

    // Görünüm (Aylık/Yıllık) filtresi değiştiğinde takvimin görünümünü değiştir
    document.getElementById('viewSelect').addEventListener('change', (event) => {
        if (calendar) {
            calendar.changeView(event.target.value);
        }
    });

    document.getElementById('rangeBtn').addEventListener('click', calculateRange);
}

async function fetchEvents(fetchInfo, successCallback, failureCallback) {
    try {
        const countryId = document.getElementById('country').value;
        const sector = document.getElementById('sector').value;

        // Eğer filtrelerden biri boşsa (veri henüz yüklenmediyse) tatil getirme
        if (!countryId || !sector) {
            successCallback([]); // Boş bir dizi gönder
            updateSummary([]);
            return;
        }

        const res = await fetch(`/api/holidays/filter-by-sector?countryId=${countryId}&sectorType=${encodeURIComponent(sector)}`);
        if (!res.ok) throw new Error('Tatiller getirilemedi.');
        
        const holidays = await res.json();
        
        const events = holidays.map(h => ({
            title: `${h.holidayName} (${h.appliesToSector})`,
            start: h.holidayDate,
            extendedProps: h
        }));

        updateSummary(events);
        successCallback(events);
    } catch (e) {
        console.error(e);
        failureCallback(e);
    }
}

function updateSummary(events) {
    const summary = document.getElementById('holidaySummary');
    if (events.length === 0) {
        summary.textContent = 'Seçili kriterlere göre tatil bulunamadı.';
        return;
    }
    const items = events.map(ev => {
        const dateStr = new Date(ev.start).toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' });
        return `<li>${dateStr} - ${ev.title}</li>`;
    }).join('');
    summary.innerHTML = `<ul>${items}</ul>`;
}

function showDetails(info) {
    const h = info.event.extendedProps;
    const dateStr = new Date(h.holidayDate).toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const details = `
        <h3>${h.holidayName}</h3>
        <p><strong>Türü:</strong> ${h.holidayType}</p>
        <p><strong>Tarih:</strong> ${dateStr}</p>
        <p><strong>Süre:</strong> ${h.durationDays} gün</p>
        <p><strong>Geçerli Sektör:</strong> ${h.appliesToSector}</p>
    `;
    document.getElementById('holidayDetails').innerHTML = details;
}

async function calculateRange() {
    const countryId = document.getElementById('country').value;
    const sector = document.getElementById('sector').value;
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;

    if (!countryId || !sector || !start || !end) {
        document.getElementById('rangeResult').textContent = 'Lütfen tüm alanları doldurun.';
        return;
    }

    try {
        const res = await fetch(`/api/holidays/range?countryId=${countryId}&sectorType=${encodeURIComponent(sector)}&start=${start}&end=${end}`);
        if (!res.ok) throw new Error('Tatiller getirilemedi.');
        const holidays = await res.json();
        document.getElementById('rangeResult').textContent = `Toplam ${holidays.length} tatil bulundu.`;
    } catch (e) {
        console.error(e);
        document.getElementById('rangeResult').textContent = 'Hata oluştu.';
    }
}

async function init() {
    // 1. Önce takvimi ekrana çiz.
    initializeCalendar();
    
    // 2. Sonra filtreler için gerekli verileri (ülke, sektör) yükle.
    await Promise.all([loadCountries(), loadSectorTypes()]);
    
    // 3. Veriler yüklendikten sonra, takvimin ilk verilerini getirmesi için onu tetikle.
    calendar.refetchEvents();

    // 4. Son olarak, filtrelerin değişikliklerini dinleyecek olan kodları çalıştır.
    setupEventListeners();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>