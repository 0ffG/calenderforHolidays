<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tatil Takvimi</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(to right, #f8fbff, #e0eafc);
        }

        #controls {
            margin-bottom: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        #controls label {
            margin-right: 5px;
            font-weight: bold;
        }

        #rangeBtn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        #rangeBtn:hover {
            background-color: #0056b3;
        }

        #calendar {
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .fc-daygrid-day.fc-day-today {
            background-color: #ffe4e1;
        }

        #holidayDetails {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 5px;
        }

        #holidaySummary {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div id="controls">
    <div style="margin-bottom: 20px; display:flex; gap:10px; align-items:center;">
        <label for="country" id="lblCountry">Country:</label>
        <select id="country"></select>

        <label for="viewSelect" id="lblView">View:</label>
        <select id="viewSelect">
            <option value="dayGridMonth" id="optMonth">Monthly</option>
            <option value="multiMonthYear" id="optYear">Yearly</option>
        </select>

        <label for="lang" id="lblLang">Language:</label>
        <select id="lang">
            <option value="en">EN</option>
            <option value="fr">FR</option>
        </select>
    </div>

    <div id="calendar" style="margin-bottom: 20px;"></div>

    <div style="margin-bottom: 20px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <label for="type" id="lblType">Type:</label>
        <select id="type"></select>

        <label for="sector" id="lblTarget">Target Group:</label>
        <select id="sector"></select>

        <label for="startDate" id="lblStart">Start:</label>
        <input type="date" id="startDate">
        <label for="endDate" id="lblEnd">End:</label>
        <input type="date" id="endDate">
        <button id="rangeBtn">Calculate Range</button>
    </div>

    <div id="rangeResult" style="margin-top: 10px;"></div>
</div>

<div id="holidaySummary" style="margin-top: 20px;"></div>
<div id="holidayDetails" style="margin-top: 20px;"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
// Takvim nesnesini daha geniş bir kapsamda tanımlayalım ki her yerden ulaşılabilsin.
let calendar;
let currentLang = 'en';
let translations = {};

async function loadTranslations(lang) {
    const res = await fetch(`/lang/${lang}.json`);
    translations = await res.json();
    currentLang = lang;
    document.getElementById('lblCountry').textContent = translations.country + ':';
    document.getElementById('lblView').textContent = translations.view + ':';
    document.getElementById('optMonth').textContent = translations.month;
    document.getElementById('optYear').textContent = translations.year;
    document.getElementById('lblType').textContent = translations.type + ':';
    document.getElementById('lblLang').textContent = translations.language + ':';
    document.getElementById('lblTarget').textContent = translations.targetGroup + ':';
    document.getElementById('lblStart').textContent = translations.start + ':';
    document.getElementById('lblEnd').textContent = translations.end + ':';
    document.getElementById('rangeBtn').textContent = translations.calculate;
    if (calendar) {
        calendar.setOption('locale', lang);
    }
    loadDescriptions();
}

async function loadCountries() {
    try {
        const res = await fetch('/api/countries');
        if (!res.ok) throw new Error('Ülkeler yüklenemedi.');
        const countries = await res.json();
        const select = document.getElementById('country');
        select.innerHTML = ''; // Önceki seçenekleri temizle
        countries.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.countryId;
            opt.textContent = c.countryName;
            select.appendChild(opt);
        });
    } catch (e) {
        console.error(e);
    }
}

async function loadSectorTypes() {
    try {
        const res = await fetch('/api/target-groups');
        if (!res.ok) throw new Error('Types load error');
        const types = await res.json();
        const select = document.getElementById('sector');
        select.innerHTML = ''; // Önceki seçenekleri temizle
        types.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.code;
            opt.textContent = t.code;
            select.appendChild(opt);
        });
    } catch (e) {
        console.error(e);
    }
}

async function loadHolidayTypes() {
    try {
        const res = await fetch('/api/holiday-types');
        if (!res.ok) throw new Error('type err');
        const types = await res.json();
        const select = document.getElementById('type');
        select.innerHTML = '';
        types.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.code;
            opt.textContent = t.code;
            select.appendChild(opt);
        });
    } catch (e) {
        console.error(e);
    }
}

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 650,
        views: {
            multiMonthYear: { type: 'multiMonth', duration: { months: 12 } }
        },
        events: fetchEvents,
        eventClick: showDetails,
        locale: currentLang
    });
    calendar.render();
}

async function loadDescriptions() {
    const countryId = document.getElementById('country').value;
    if (!countryId) {
        document.getElementById('holidaySummary').innerHTML = '';
        return;
    }
    try {
        const res = await fetch(`/api/holidays/descriptions?countryId=${countryId}&language=${currentLang}`);
        if (!res.ok) throw new Error('desc');
        const list = await res.json();
        const items = list.map(d => {
            const dateStr = new Date(d.startDate).toLocaleDateString(currentLang);
            return `<li>${dateStr} - <strong>${d.name}</strong>: ${d.description}</li>`;
        }).join('');
        document.getElementById('holidaySummary').innerHTML = `<ul>${items}</ul>`;
    } catch (e) {
        console.error(e);
    }
}

function setupEventListeners() {
    ['country', 'sector'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            if (calendar) {
                calendar.refetchEvents();
            }
            if (id === 'country') loadDescriptions();
        });
    });

    document.getElementById('lang').addEventListener('change', e => {
        loadTranslations(e.target.value);
    });

    // Change calendar view when selection changes
    document.getElementById('viewSelect').addEventListener('change', (event) => {
        if (calendar) {
            calendar.changeView(event.target.value);
        }
    });

    document.getElementById('rangeBtn').addEventListener('click', calculateRange);
}

async function fetchEvents(fetchInfo, successCallback, failureCallback) {
    try {
        const countryId = document.getElementById('country').value;
        const sector = document.getElementById('sector').value;

        // Eğer filtrelerden biri boşsa (veri henüz yüklenmediyse) tatil getirme
        if (!countryId || !sector) {
            successCallback([]);
            updateSummary([]);
            return;
        }

        const res = await fetch(`/api/holidays/filter?countryId=${countryId}&targetGroup=${encodeURIComponent(sector)}`);
        if (!res.ok) throw new Error('Tatiller getirilemedi.');
        
        const holidays = await res.json();
        
        const events = holidays.map(h => ({
            title: `${h.holidayName} (${h.appliesToSector})`,
            start: h.holidayDate,
            extendedProps: h
        }));

        updateSummary(events);
        successCallback(events);
    } catch (e) {
        console.error(e);
        failureCallback(e);
    }
}

function updateSummary(events) {
    const summary = document.getElementById('holidaySummary');
    if (events.length === 0) {
        summary.textContent = translations.noHolidays;
        return;
    }
    const items = events.map(ev => {
        const dateStr = new Date(ev.start).toLocaleDateString(currentLang, { day: '2-digit', month: 'long', year: 'numeric' });
        return `<li>${dateStr} - ${ev.title}</li>`;
    }).join('');
    summary.innerHTML = `<ul>${items}</ul>`;
}

function showDetails(info) {
    const h = info.event.extendedProps;
    const dateStr = new Date(h.holidayDate).toLocaleDateString(currentLang, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const details = `
        <h3>${h.holidayName}</h3>
        <p><strong>Type:</strong> ${h.holidayType}</p>
        <p><strong>Date:</strong> ${dateStr}</p>
        <p><strong>Duration:</strong> ${h.durationDays} days</p>
        <p><strong>Target:</strong> ${h.appliesToSector}</p>
    `;
    document.getElementById('holidayDetails').innerHTML = details;
}

async function calculateRange() {
    const countryId = document.getElementById('country').value;
    const sector = document.getElementById('sector').value;
    const type = document.getElementById('type').value;
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;

    if (!countryId || !sector || !type || !start || !end) {
        document.getElementById('rangeResult').textContent = 'Please fill all fields.';
        return;
    }

    try {
        const res = await fetch(`/api/holidays/range-filtered?countryId=${countryId}&holidayType=${encodeURIComponent(type)}&targetGroup=${encodeURIComponent(sector)}&start=${start}&end=${end}`);
        if (!res.ok) throw new Error('Tatiller getirilemedi.');
        const holidays = await res.json();

        const holidayDates = new Set(holidays.map(h => h.holidayDate));
        let workDays = 0;
        let current = new Date(start);
        const endDate = new Date(end);
        while (current <= endDate) {
            const day = current.getDay();
            const iso = current.toISOString().slice(0,10);
            if (day !== 0 && day !== 6 && !holidayDates.has(iso)) {
                workDays++;
            }
            current.setDate(current.getDate() + 1);
        }

        document.getElementById('rangeResult').textContent =
            `${holidays.length} holidays, ${workDays} work days.`;
    } catch (e) {
        console.error(e);
        document.getElementById('rangeResult').textContent = 'Hata oluştu.';
    }
}

async function init() {
    await loadTranslations(currentLang);
    initializeCalendar();

    await Promise.all([loadCountries(), loadSectorTypes(), loadHolidayTypes()]);
    calendar.refetchEvents();
    setupEventListeners();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>