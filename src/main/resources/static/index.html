<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Holiday Calendar</title>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #calendar {
      max-width: 900px;
      margin: 40px auto;
    }
    .form-section {
      max-width: 600px;
      margin: auto;
      padding: 20px;
      border: 1px solid #ccc;
    }
    .form-section label, .form-section select, .form-section input {
      display: block;
      width: 100%;
      margin: 10px 0;
    }
    .result {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2 style="text-align:center;" id="page-title">📅 Holiday Calendar</h2>

  <!-- 🌐 Dil Seçimi -->
  <label for="language-select" id="language-label">Select Language:</label>
  <select id="language-select">
    <option value="en" selected>English</option>
    <option value="tr">Türkçe</option>
    <option value="fr">Français</option>
  </select>

  <!-- 🌍 Ülke Seçimi -->
  <label for="country-select" id="country-label">Select Country:</label>
  <select id="country-select"></select>

  <!-- 📅 Takvim -->
  <div id="calendar"></div>

  <!-- 🧮 Tatil ve İş Günü Hesaplayıcı -->
  <div class="form-section">
    <h3 id="calculator-title">🧮 Holiday and Working Day Calculator</h3>
    
    <label for="start-date" id="start-date-label">Start Date:</label>
    <input type="date" id="start-date" />

    <label for="end-date" id="end-date-label">End Date:</label>
    <input type="date" id="end-date" />

    <label for="workplace" id="workplace-label">Workplace Type:</label>
    <select id="workplace"></select>

    <label for="target-group" id="target-group-label">Target Group (optional):</label>
    <select id="target-group"></select>

    <button onclick="calculate()" id="calculate-button">Calculate</button>

    <div class="result" id="result"></div>
  </div>

  <script>
    let currentLang = 'en'; // Default to English

    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'dayGridMonth',
      events: []
    });
    calendar.render();

    async function loadUITexts() {
      const res = await fetch(`/api/ui-texts?lang=${currentLang}`);
      const texts = await res.json();
      
      document.getElementById('page-title').textContent = texts.pageTitle;
      document.getElementById('language-label').textContent = texts.languageLabel;
      document.getElementById('country-label').textContent = texts.countryLabel;
      document.getElementById('calculator-title').textContent = texts.calculatorTitle;
      document.getElementById('start-date-label').textContent = texts.startDateLabel;
      document.getElementById('end-date-label').textContent = texts.endDateLabel;
      document.getElementById('workplace-label').textContent = texts.workplaceLabel;
      document.getElementById('target-group-label').textContent = texts.targetGroupLabel;
      document.getElementById('calculate-button').textContent = texts.calculateButton;
    }

    async function loadCountries() {
      const res = await fetch(`/api/countries?lang=${currentLang}`);
      const countries = await res.json();
      const select = document.getElementById('country-select');
      select.innerHTML = '';
      countries.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.name;
        select.appendChild(option);
      });
      if (countries.length > 0) {
        select.value = countries[0].id;
        loadHolidays(countries[0].id);
      }
    }

    async function loadWorkplaceTypes() {
      const res = await fetch(`/api/workplace-types?lang=${currentLang}`);
      const types = await res.json();
      const select = document.getElementById('workplace');
      select.innerHTML = '';
      types.forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = t.name;
        select.appendChild(option);
      });
    }

    async function loadTargetGroups() {
      const res = await fetch(`/api/target-groups?lang=${currentLang}`);
      const groups = await res.json();
      const select = document.getElementById('target-group');
      select.innerHTML = '';
      
      // Add default empty option
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = groups.length > 0 ? groups[0].defaultText || '-- Select --' : '-- Select --';
      select.appendChild(emptyOption);
      
      groups.forEach(g => {
        const option = document.createElement('option');
        option.value = g.id;
        option.textContent = g.name;
        select.appendChild(option);
      });
    }

    async function loadHolidays(countryId) {
      const res = await fetch(`/api/holidays?countryId=${countryId}&lang=${currentLang}`);
      const holidays = await res.json();
      calendar.removeAllEvents();
      holidays.forEach(h => {
        calendar.addEvent({
          title: h.name,
          start: h.date,
          allDay: true
        });
      });
    }

    function calculate() {
      const start = document.getElementById('start-date').value;
      const end = document.getElementById('end-date').value;
      const type = document.getElementById('workplace').value;
      const group = document.getElementById('target-group').value;
      const countryId = document.getElementById('country-select').value;

      fetch('/api/calculate-working-days', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          startDate: start,
          endDate: end,
          workplaceType: type,
          targetGroupId: group || null,
          countryId: countryId,
          language: currentLang
        })
      })
      .then(res => res.json())
      .then(result => {
        document.getElementById('result').textContent =
          `${result.holidayDaysLabel}: ${result.holidayDays}, ${result.workingDaysLabel}: ${result.workingDays}`;
      });
    }

    async function loadAllData() {
      await loadUITexts();
      await loadCountries();
      await loadWorkplaceTypes();
      await loadTargetGroups();
    }

    document.getElementById('language-select').addEventListener('change', (e) => {
      currentLang = e.target.value;
      loadAllData();
    });

    document.getElementById('country-select').addEventListener('change', (e) => {
      loadHolidays(e.target.value);
    });

    // İlk yükleme
    loadAllData();
  </script>
</body>
</html>
